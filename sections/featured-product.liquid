<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
{{ 'featured-product.css' | asset_url | stylesheet_tag }}

{%- assign product = all_products[section.settings.product] -%}
{%- if product == blank -%}
  <p class="{% if section.settings.dark_mode %}text-gray-300{% endif %}">
    {{ 'products.product.banner.not_found' | t }}
  </p>
{%- else -%}
  <div class="py-14 px-5 {% if section.settings.dark_mode %}bg-gray-900{% else %}bg-white{% endif %} transition-colors duration-300">
    <div class="flex gap-14 max-w-screen-2xl mx-auto">
      <div class="flex gap-5">
        {%- unless product.images == blank -%}
          <div class="featured-product__thumbs swiper">
            <div class="swiper-wrapper">
              {%- assign white_images = product.images | where_exp: 'img', "img.src contains 'white'" -%}
              {%- for image in white_images limit: 5 -%}
                <div class="swiper-slide">
                  <img
                    width="88"
                    height="88"
                    src="{{ image | image_url: width: 88, height: 88 }}"
                    alt="{{ image.alt | default: product.title | escape }}"
                  >
                </div>
              {%- endfor -%}
            </div>
          </div>
        {%- endunless -%}
        <div class="relative">
          {%- if section.settings.rated -%}
            <div class="flex items-center {% if section.settings.dark_mode %}bg-gray-700{% else %}bg-white{% endif %} rounded absolute top-4 left-4 justify-center gap-1 w-32 h-9 z-10 transition-colors duration-300">
              <div class="flex justify-center items-center {% if section.settings.dark_mode %}text-yellow-400{% else %}text-black{% endif %}">
                {{ 'star-small.svg' | inline_asset_content }}
              </div>
              <div class="{% if section.settings.dark_mode %}text-white{% else %}text-black{% endif %} font-normal text-sm leading-5">
                {{ 'products.product.banner.highly_rated' | t }}
              </div>
            </div>
          {%- endif -%}

          <div class="featured-product__swiper swiper">
            <div class="swiper-wrapper">
              {%- unless product.images == blank -%}
                {%- assign white_images = product.images | where_exp: 'img', "img.src contains 'white'" -%}
                {%- for image in white_images limit: 5 -%}
                  <div class="swiper-slide">
                    <img
                      width="536"
                      height="536"
                      src="{{ image | image_url: width: 536, height: 536 }}"
                      alt="{{ image.alt | default: product.title | escape }}"
                    >
                  </div>
                {%- endfor -%}
              {%- else -%}
                <div class="swiper-slide">
                  {{ 'product-1' | placeholder_svg_tag }}
                </div>
              {%- endunless -%}
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-col gap-8">
        <div class="flex flex-col gap-3">
          <h1 class="featured-product__title {% if section.settings.dark_mode %}text-white{% endif %}">
            {{ product.title | escape }}
          </h1>

          {%- assign selected_variant = product.selected_or_first_available_variant -%}

          <div class="flex flex-col gap-2">
            <div id="variant-price">
              {%- render 'price-block', variant: selected_variant -%}
            </div>
            <div class="text-sm leading-5" id="variant-availability">
              {%- if selected_variant.available -%}
                {%- if selected_variant.inventory_quantity > 0 -%}
                  <span class="{% if section.settings.dark_mode %}text-green-400{% else %}text-green-600{% endif %} font-medium">
                    {{-
                      'products.product.banner.in_stock_count'
                      | t: count: selected_variant.inventory_quantity
                      | default: selected_variant.inventory_quantity
                    }}
                    {{ 'products.product.banner.in_stock' | t | default: 'в наявності' -}}
                  </span>
                {%- else -%}
                  <span class="{% if section.settings.dark_mode %}text-green-400{% else %}text-green-600{% endif %} font-medium">
                    {{- 'products.product.banner.available' | t | default: 'Доступно' -}}
                  </span>
                {%- endif -%}
              {%- else -%}
                <span class="{% if section.settings.dark_mode %}text-red-400{% else %}text-red-600{% endif %} font-medium">
                  {{- 'products.product.banner.unavailable' | t | default: 'Немає в наявності' -}}
                </span>
              {%- endif -%}
            </div>
          </div>
        </div>

        <form method="post" action="/cart/add" id="featured-product-form">
          <input
            type="hidden"
            name="id"
            id="product-variant-id"
            value="{{ product.selected_or_first_available_variant.id }}"
          >

          <div class="flex flex-col gap-8">
            {%- if product.variants != blank -%}
              {%- assign seen_colors = '' -%}

              <div class="flex gap-2">
                {%- for variant in product.variants -%}
                  {%- assign color = variant.option1 -%}
                  {%- unless seen_colors contains color -%}
                    {%- assign seen_colors = seen_colors | append: color | append: ',' -%}
                    {%- render 'color-button', variant: variant, is_first: forloop.first -%}
                  {%- endunless -%}
                {%- endfor -%}
              </div>

              {%- assign seen_sizes = '' -%}
              {%- assign has_sizes = false -%}

              {%- for variant in product.variants -%}
                {%- if variant.option2 != blank -%}
                  {%- assign has_sizes = true -%}
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}

              {%- if has_sizes -%}
                <h3 class="{% if section.settings.dark_mode %}text-white{% endif %}">
                  {{ 'products.product.banner.select_size' | t }}
                </h3>
                <div class="w-full min-w-min flex flex-wrap gap-2">
                  {%- for variant in product.variants -%}
                    {%- if variant.option2 != blank -%}
                      {%- assign size = variant.option2 -%}
                      {%- unless seen_sizes contains size -%}
                        {%- assign seen_sizes = seen_sizes | append: size | append: ',' -%}
                        <button
                          type="button"
                          name="size"
                          class="flex justify-center items-center w-56 max-w-xs h-14 border rounded-lg duration-200 hover:cursor-pointer featured-product__size transition-colors {% if section.settings.dark_mode %}border-gray-600 bg-gray-800 text-white hover:border-white{% else %}border-gray-300 bg-white text-black hover:border-black{% endif %}"
                          data-size="{{ variant.option2 }}"
                        >
                          {{ variant.option2 }}
                        </button>
                      {%- endunless -%}
                    {%- endif -%}
                  {%- endfor -%}
                </div>
              {%- endif -%}
            {%- endif -%}
          </div>

          <button
            class="featured-product__submit-btn rounded-lex justify-center items-center w-full h-14 border-none mt-4 cursor-pointer transition-colors duration-200 {% if section.settings.dark_mode %}bg-white text-black hover:bg-gray-100{% else %}bg-black text-white hover:bg-gray-800{% endif %}"
            type="submit"
          >
            {{ 'products.product.banner.add_to_bag' | t }}
          </button>
        </form>

        {%- if section.settings.content != blank -%}
          <p class="featured-product__content {% if section.settings.dark_mode %}text-gray-300{% endif %}">
            {{ section.settings.content }}
          </p>
        {%- endif -%}
      </div>
    </div>
  </div>
{%- endif -%}

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js" defer></script>
<script>
  const isDarkMode = {{ section.settings.dark_mode | json }};

  const productImages = {
    {% for image in product.images %}
    "{{ image.src | split: '/' | last | split: '.' | first }}": {
      src: "{{ image | image_url: width: 536, height: 536 }}",
      thumb: "{{ image | image_url: width: 88, height: 88 }}",
      alt: "{{ image.alt | escape }}"
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  };

  const productVariants = [
    {% for variant in product.variants %}
    {
      id: {{ variant.id }},
      options: {{ variant.options | json }},
      available: {{ variant.available | json }},
      price: {{ variant.price }},
      compare_at_price: {{ variant.compare_at_price | default: 0 }},
      inventory_quantity: {{ variant.inventory_quantity | default: 0 }}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];

  document.addEventListener('DOMContentLoaded', function () {
    const colorButtons = document.querySelectorAll('.featured-product__color');
    const sizeButtons = document.querySelectorAll('.featured-product__size');
    const variantIdInput = document.getElementById('product-variant-id');
    const variantPriceContainer = document.getElementById('variant-price');
    const variantAvailabilityContainer = document.getElementById('variant-availability');
    const submitButton = document.querySelector('.featured-product__submit-btn');
    const form = document.getElementById('featured-product-form');

    let selectedOptions = {
      color: colorButtons[0]?.getAttribute('data-color-name') || '',
      size: ''
    };

    const thumbsSwiper = new Swiper('.featured-product__thumbs', {
      spaceBetween: 8,
      slidesPerView: 'auto',
      direction: 'vertical',
      watchSlidesProgress: true,
      slideToClickedSlide: true,
    });

    const mainSwiper = new Swiper('.featured-product__swiper', {
      spaceBetween: 10,
      thumbs: {
        swiper: thumbsSwiper,
      },
    });

    function formatMoney(cents) {
      return (cents / 100).toFixed(2);
    }

    function updateVariantInfo() {
      if (!selectedOptions.size) {
        const colorVariants = productVariants.filter(variant => {
          return variant.options[0].toLowerCase() === selectedOptions.color.toLowerCase();
        });

        if (colorVariants.length > 0) {
          const firstVariant = colorVariants[0];
          variantIdInput.value = firstVariant.id;

          let priceHTML = '';
          if (firstVariant.compare_at_price > firstVariant.price) {
            priceHTML = `
              <span class="${isDarkMode ? 'text-white' : ''}" data-price>$${formatMoney(firstVariant.price)}</span>
              <s class="line-through ${isDarkMode ? 'decoration-red-400 text-gray-300' : 'decoration-red-600'}" data-compare-price>$${formatMoney(firstVariant.compare_at_price)}</s>
            `;
          } else {
            priceHTML = `<span class="${isDarkMode ? 'text-white' : ''}" data-price>$${formatMoney(firstVariant.price)}</span>`;
          }
          variantPriceContainer.innerHTML = priceHTML;

          const totalStock = colorVariants.reduce((sum, v) => sum + v.inventory_quantity, 0);
          const hasAvailable = colorVariants.some(v => v.available);

          let availabilityHTML = '';
          if (hasAvailable) {
            if (totalStock > 0) {
              availabilityHTML = `<span class="${isDarkMode ? 'text-green-400' : 'text-green-600'} font-medium">${totalStock} {{ 'products.product.banner.in_stock_all_sizes' | t | default: 'в наявності (всі розміри)' }}</span>`;
            } else {
              availabilityHTML = `<span class="${isDarkMode ? 'text-green-400' : 'text-green-600'} font-medium">{{ 'products.product.banner.available' | t | default: 'Доступно' }}</span>`;
            }
          } else {
            availabilityHTML = `<span class="${isDarkMode ? 'text-red-400' : 'text-red-600'} font-medium">{{ 'products.product.banner.unavailable' | t | default: 'Немає в наявності' }}</span>`;
          }
          variantAvailabilityContainer.innerHTML = availabilityHTML;

          if (!hasAvailable || totalStock === 0) {
            submitButton.disabled = true;
            submitButton.classList.add('featured-product__submit-btn--disabled');
          } else {
            submitButton.disabled = false;
            submitButton.classList.remove('featured-product__submit-btn--disabled');
          }
        }
        return;
      }

      const selectedVariant = productVariants.find(variant => {
        return variant.options.every((option, index) => {
          if (index === 0) return option.toLowerCase() === selectedOptions.color.toLowerCase();
          if (index === 1) return option === selectedOptions.size;
          return true;
        });
      });

      if (selectedVariant) {
        variantIdInput.value = selectedVariant.id;

        let priceHTML = '';
        if (selectedVariant.compare_at_price > selectedVariant.price) {
          priceHTML = `
            <span class="${isDarkMode ? 'text-white' : ''}" data-price>$${formatMoney(selectedVariant.price)}</span>
            <s class="line-through ${isDarkMode ? 'decoration-red-400 text-gray-300' : 'decoration-red-600'}" data-compare-price>$${formatMoney(selectedVariant.compare_at_price)}</s>
          `;
        } else {
          priceHTML = `<span class="${isDarkMode ? 'text-white' : ''}" data-price>$${formatMoney(selectedVariant.price)}</span>`;
        }
        variantPriceContainer.innerHTML = priceHTML;

        let availabilityHTML = '';
        if (selectedVariant.available) {
          if (selectedVariant.inventory_quantity > 0) {
            availabilityHTML = `<span class="${isDarkMode ? 'text-green-400' : 'text-green-600'} font-medium">${selectedVariant.inventory_quantity} {{ 'products.product.banner.in_stock' | t | default: 'в наявності' }}</span>`;
          } else {
            availabilityHTML = `<span class="${isDarkMode ? 'text-green-400' : 'text-green-600'} font-medium">{{ 'products.product.banner.available' | t | default: 'Доступно' }}</span>`;
          }
        } else {
          availabilityHTML = `<span class="${isDarkMode ? 'text-red-400' : 'text-red-600'} font-medium">{{ 'products.product.banner.unavailable' | t | default: 'Немає в наявності' }}</span>`;
        }
        variantAvailabilityContainer.innerHTML = availabilityHTML;
      }
    }

    function updateGallery(colorName, variantImage = null, variantImageAlt = '') {
      mainSwiper.removeAllSlides();
      thumbsSwiper.removeAllSlides();

      const filteredImages = Object.entries(productImages)
        .filter(([filename]) => filename.toLowerCase().includes(colorName.toLowerCase()));

      console.log('Filtered images for color:', colorName, filteredImages.length);

      if (variantImage && filteredImages.length > 0) {
        const variantImageFilename = variantImage.split('/').pop().split('?')[0];
        let variantIndex = -1;

        filteredImages.forEach(([filename], index) => {
          if (variantImage.includes(filename)) {
            variantIndex = index;
          }
        });

        if (variantIndex !== -1) {
          const [variantEntry] = filteredImages.splice(variantIndex, 1);
          filteredImages.unshift(variantEntry);
        }
      }

      filteredImages.slice(0, 5).forEach(([filename, imageData]) => {
        mainSwiper.appendSlide(`
          <div class="swiper-slide">
            <img src="${imageData.src}" alt="${imageData.alt}" width="536" height="536">
          </div>
        `);

        thumbsSwiper.appendSlide(`
          <div class="swiper-slide">
            <img src="${imageData.thumb}" alt="${imageData.alt}" width="88" height="88">
          </div>
        `);
      });

      mainSwiper.slideTo(0);
      thumbsSwiper.slideTo(0);
      mainSwiper.update();
      thumbsSwiper.update();
    }

    colorButtons.forEach((button) => {
      button.addEventListener('click', function () {
        const colorName = this.getAttribute('data-color-name');
        const variantImage = this.getAttribute('data-variant-image');
        const variantImageAlt = this.getAttribute('data-variant-image-alt');

        console.log('Color button clicked:', {
          colorName,
          variantImage,
          variantImageAlt
        });

        if (colorName) {
          selectedOptions.color = colorName;
          updateGallery(colorName, variantImage, variantImageAlt);
          updateVariantInfo();
        }

        colorButtons.forEach((btn) => btn.classList.remove('featured-product__btn--active'));
        this.classList.add('featured-product__btn--active');
      });
    });

    sizeButtons.forEach((button) => {
      button.addEventListener('click', function () {
        const size = this.getAttribute('data-size');
        selectedOptions.size = size;
        updateVariantInfo();

        sizeButtons.forEach((btn) => btn.classList.remove('featured-product__btn--active'));
        this.classList.add('featured-product__btn--active');
      });
    });

    form.addEventListener('submit', function(e) {
      e.preventDefault();

      const formData = new FormData(form);

      fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: variantIdInput.value,
          quantity: 1
        })
      })
      .then(response => response.json())
      .then(data => {
        window.location.href = '/cart';
      })
      .catch(error => {
        console.error('Error:', error);
      });
    });
  });
</script>

{% schema %}
{
  "name": "Featured Product",
  "tag": "section",
  "class": "featured-product",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product"
    },
    {
      "type": "checkbox",
      "id": "rated",
      "label": "Show highly rated badge",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "dark_mode",
      "label": "Enable Dark Mode",
      "default": false,
      "info": "Turn on dark theme for this section"
    },
    {
      "type": "textarea",
      "id": "content",
      "label": "Product description"
    }
  ],
  "presets": [
    {
      "name": "Featured Product"
    }
  ]
}
{% endschema %}
